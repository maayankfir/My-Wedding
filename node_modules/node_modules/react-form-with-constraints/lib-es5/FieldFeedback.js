"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var PropTypes = require("prop-types");
var FormWithConstraints_1 = require("./FormWithConstraints");
var FieldFeedbacks_1 = require("./FieldFeedbacks");
var Async_1 = require("./Async");
var FieldFeedbackWhenValid_1 = require("./FieldFeedbackWhenValid");
var FieldFeedbackType_1 = require("./FieldFeedbackType");
var FieldFeedback = (function (_super) {
    __extends(FieldFeedback, _super);
    function FieldFeedback(props, context) {
        var _this = _super.call(this, props, context) || this;
        _this.validate = function (input) {
            var when = _this.props.when;
            var _a = _this.context, form = _a.form, fieldFeedbacks = _a.fieldFeedbacks;
            var field = form.fieldsStore.getField(input.name);
            var validation = __assign({}, _this.state.validation);
            if (fieldFeedbacks.props.stop === 'first' && field.hasFeedbacks(fieldFeedbacks.key) ||
                fieldFeedbacks.props.stop === 'first-error' && field.hasErrors(fieldFeedbacks.key) ||
                fieldFeedbacks.props.stop === 'first-warning' && field.hasWarnings(fieldFeedbacks.key) ||
                fieldFeedbacks.props.stop === 'first-info' && field.hasInfos(fieldFeedbacks.key)) {
                validation.show = undefined;
            }
            else {
                validation.show = false;
                if (typeof when === 'function') {
                    validation.show = when(input.value);
                }
                else if (typeof when === 'string') {
                    if (when === 'valid') {
                        validation.show = undefined;
                    }
                    else {
                        var validity = input.validity;
                        if (!validity.valid) {
                            if (when === '*') {
                                validation.show = true;
                            }
                            else if (validity.badInput && when === 'badInput' ||
                                validity.patternMismatch && when === 'patternMismatch' ||
                                validity.rangeOverflow && when === 'rangeOverflow' ||
                                validity.rangeUnderflow && when === 'rangeUnderflow' ||
                                validity.stepMismatch && when === 'stepMismatch' ||
                                validity.tooLong && when === 'tooLong' ||
                                validity.tooShort && when === 'tooShort' ||
                                validity.typeMismatch && when === 'typeMismatch' ||
                                validity.valueMissing && when === 'valueMissing') {
                                validation.show = true;
                            }
                        }
                    }
                }
                else {
                    throw new TypeError("Invalid FieldFeedback 'when' type: " + typeof when);
                }
            }
            field.addOrReplaceValidation(validation);
            _this.setState({
                validation: validation,
                validationMessage: input.validationMessage
            });
            return validation;
        };
        _this.fieldDidReset = function (field) {
            if (field.name === _this.context.fieldFeedbacks.fieldName) {
                _this.setState(function (prevState) { return ({
                    validation: __assign({}, prevState.validation, { show: undefined }),
                    validationMessage: ''
                }); });
            }
        };
        _this.key = context.fieldFeedbacks.addFieldFeedback();
        var error = props.error, warning = props.warning, info = props.info, when = props.when;
        var type = FieldFeedbackType_1.default.Error;
        if (when === 'valid')
            type = FieldFeedbackType_1.default.WhenValid;
        else if (warning)
            type = FieldFeedbackType_1.default.Warning;
        else if (info)
            type = FieldFeedbackType_1.default.Info;
        if (type === FieldFeedbackType_1.default.WhenValid && (error || warning || info)) {
            throw new Error('Cannot have an attribute (error, warning...) with FieldFeedback when="valid"');
        }
        _this.state = {
            validation: {
                key: _this.key,
                type: type,
                show: undefined
            },
            validationMessage: ''
        };
        return _this;
    }
    FieldFeedback.prototype.componentWillMount = function () {
        var _a = this.context, form = _a.form, fieldFeedbacks = _a.fieldFeedbacks, async = _a.async;
        if (async)
            async.addValidateFieldEventListener(this.validate);
        else
            fieldFeedbacks.addValidateFieldEventListener(this.validate);
        form.addFieldDidResetEventListener(this.fieldDidReset);
    };
    FieldFeedback.prototype.componentWillUnmount = function () {
        var _a = this.context, form = _a.form, fieldFeedbacks = _a.fieldFeedbacks, async = _a.async;
        if (async)
            async.removeValidateFieldEventListener(this.validate);
        else
            fieldFeedbacks.removeValidateFieldEventListener(this.validate);
        form.removeFieldDidResetEventListener(this.fieldDidReset);
    };
    FieldFeedback.prototype.render = function () {
        var _a = this.props, when = _a.when, error = _a.error, warning = _a.warning, info = _a.info, className = _a.className, classes = _a.classes, style = _a.style, children = _a.children, otherProps = __rest(_a, ["when", "error", "warning", "info", "className", "classes", "style", "children"]);
        var _b = this.state, validation = _b.validation, validationMessage = _b.validationMessage;
        var fieldFeedbackClassName = classes[validation.type];
        var classNames = className !== undefined ? className + " " + fieldFeedbackClassName : fieldFeedbackClassName;
        if (validation.type === FieldFeedbackType_1.default.WhenValid) {
            return React.createElement(FieldFeedbackWhenValid_1.FieldFeedbackWhenValid, __assign({ "data-feedback": this.key, style: style, className: classNames }, otherProps), children);
        }
        if (validation.show) {
            var feedback = children !== undefined ? children : validationMessage;
            return React.createElement("span", __assign({ "data-feedback": this.key, className: classNames, style: __assign({ display: 'block' }, style) }, otherProps), feedback);
        }
        return null;
    };
    FieldFeedback.defaultProps = {
        when: function () { return true; },
        classes: {
            error: 'error',
            warning: 'warning',
            info: 'info',
            whenValid: 'when-valid'
        }
    };
    FieldFeedback.contextTypes = {
        form: PropTypes.instanceOf(FormWithConstraints_1.FormWithConstraints).isRequired,
        fieldFeedbacks: PropTypes.instanceOf(FieldFeedbacks_1.FieldFeedbacks).isRequired,
        async: PropTypes.instanceOf(Async_1.Async)
    };
    return FieldFeedback;
}(React.Component));
exports.FieldFeedback = FieldFeedback;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmllbGRGZWVkYmFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9GaWVsZEZlZWRiYWNrLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZCQUErQjtBQUMvQixzQ0FBd0M7QUFFeEMsNkRBQTZGO0FBQzdGLG1EQUE4RTtBQUM5RSxpQ0FBbUQ7QUFHbkQsbUVBQWtFO0FBQ2xFLHlEQUFvRDtBQW1EcEQ7SUFBOEYsaUNBQTBDO0lBcUJ0SSx1QkFBWSxLQUFZLEVBQUUsT0FBNkI7UUFBdkQsWUFDRSxrQkFBTSxLQUFLLEVBQUUsT0FBTyxDQUFDLFNBd0J0QjtRQW9CRCxjQUFRLEdBQUcsVUFBQyxLQUFtQjtZQUNyQixJQUFBLHVCQUFJLENBQWdCO1lBQ3RCLElBQUEsa0JBQXVDLEVBQXJDLGNBQUksRUFBRSxrQ0FBK0IsQ0FBQztZQUU5QyxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFFLENBQUM7WUFFckQsSUFBTSxVQUFVLGdCQUFPLEtBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7WUFFOUMsSUFBSSxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxPQUFPLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDO2dCQUMvRSxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxhQUFhLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDO2dCQUNsRixjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxlQUFlLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDO2dCQUN0RixjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxZQUFZLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxjQUFj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RSxTQUFTLENBQUMsVUFBVSxDQUFDLHlDQUFtQixDQUFDLENBQUMsVUFBVTtRQUMxRCxjQUFjLEVBQUUsU0FBUyxDQUFDLFVBQVUsQ0FBQywrQkFBYyxDQUFDLENBQUMsVUFBVTtRQUMvRCxLQUFLLEVBQUUsU0FBUyxDQUFDLFVBQVUsQ0FBQyxhQUFLLENBQUM7S0FDbkMsQ0FBQztJQW9KSixvQkFBQztDQUFBLEFBbktELENBQThGLEtBQUssQ0FBQyxTQUFTLEdBbUs1RztBQW5LWSxzQ0FBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCAqIGFzIFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcblxuaW1wb3J0IHsgRm9ybVdpdGhDb25zdHJhaW50cywgRm9ybVdpdGhDb25zdHJhaW50c0NoaWxkQ29udGV4dCB9IGZyb20gJy4vRm9ybVdpdGhDb25zdHJhaW50cyc7XG5pbXBvcnQgeyBGaWVsZEZlZWRiYWNrcywgRmllbGRGZWVkYmFja3NDaGlsZENvbnRleHQgfSBmcm9tICcuL0ZpZWxkRmVlZGJhY2tzJztcbmltcG9ydCB7IEFzeW5jLCBBc3luY0NoaWxkQ29udGV4dCB9IGZyb20gJy4vQXN5bmMnO1xuaW1wb3J0IHsgSW5wdXRFbGVtZW50IH0gZnJvbSAnLi9JbnB1dEVsZW1lbnQnO1xuaW1wb3J0IEZpZWxkRmVlZGJhY2tWYWxpZGF0aW9uIGZyb20gJy4vRmllbGRGZWVkYmFja1ZhbGlkYXRpb24nO1xuaW1wb3J0IHsgRmllbGRGZWVkYmFja1doZW5WYWxpZCB9IGZyb20gJy4vRmllbGRGZWVkYmFja1doZW5WYWxpZCc7XG5pbXBvcnQgRmllbGRGZWVkYmFja1R5cGUgZnJvbSAnLi9GaWVsZEZlZWRiYWNrVHlwZSc7XG5pbXBvcnQgRmllbGQgZnJvbSAnLi9GaWVsZCc7XG5pbXBvcnQgTnVsbGFibGUgZnJvbSAnLi9OdWxsYWJsZSc7XG5cbnR5cGUgV2hlblN0cmluZyA9XG4gIHwgJ3ZhbGlkJ1xuICB8ICcqJ1xuICB8ICdiYWRJbnB1dCcgICAgICAgIC8vIGlucHV0IHR5cGU9XCJudW1iZXJcIlxuICB8ICdwYXR0ZXJuTWlzbWF0Y2gnIC8vIHBhdHRlcm4gYXR0cmlidXRlXG4gIHwgJ3JhbmdlT3ZlcmZsb3cnICAgLy8gbWF4IGF0dHJpYnV0ZVxuICB8ICdyYW5nZVVuZGVyZmxvdycgIC8vIG1pbiBhdHRyaWJ1dGVcbiAgfCAnc3RlcE1pc21hdGNoJyAgICAvLyBzdGVwIGF0dHJpYnV0ZVxuICB8ICd0b29Mb25nJyAgICAgICAgIC8vIG1heGxlbmd0aCBhdHRyaWJ1dGVcbiAgfCAndG9vU2hvcnQnICAgICAgICAvLyBtaW5sZW5ndGggYXR0cmlidXRlXG4gIHwgJ3R5cGVNaXNtYXRjaCcgICAgLy8gaW5wdXQgdHlwZT1cImVtYWlsXCIgb3IgaW5wdXQgdHlwZT1cInVybFwiXG4gIHwgJ3ZhbHVlTWlzc2luZyc7ICAgLy8gcmVxdWlyZWQgYXR0cmlidXRlXG50eXBlIFdoZW5GbiA9ICh2YWx1ZTogc3RyaW5nKSA9PiBib29sZWFuO1xudHlwZSBXaGVuID0gV2hlblN0cmluZyB8IFdoZW5GbjtcblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZEZlZWRiYWNrQ2xhc3NlcyB7XG4gIGNsYXNzZXM/OiB7IC8vIEZJWE1FIFNob3VsZCBub3QgYmUgZGVjbGFyZWQgXCI/XCIgdGhhbmtzIHRvIGRlZmF1bHRQcm9wcz9cbiAgICBbaW5kZXg6IHN0cmluZ106IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBlcnJvcj86IHN0cmluZztcbiAgICB3YXJuaW5nPzogc3RyaW5nO1xuICAgIGluZm8/OiBzdHJpbmc7XG4gICAgd2hlblZhbGlkPzogc3RyaW5nO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkRmVlZGJhY2tCYXNlUHJvcHMge1xuICB3aGVuPzogV2hlbjsgLy8gRklYTUUgU2hvdWxkIG5vdCBiZSBkZWNsYXJlZCBcIj9cIiB0aGFua3MgdG8gZGVmYXVsdFByb3BzP1xuICBlcnJvcj86IGJvb2xlYW47XG4gIHdhcm5pbmc/OiBib29sZWFuO1xuICBpbmZvPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZEZlZWRiYWNrUHJvcHMgZXh0ZW5kcyBGaWVsZEZlZWRiYWNrQmFzZVByb3BzLCBGaWVsZEZlZWRiYWNrQ2xhc3NlcywgUmVhY3QuSFRNTEF0dHJpYnV0ZXM8SFRNTFNwYW5FbGVtZW50PiB7XG59XG5cbmludGVyZmFjZSBGaWVsZEZlZWRiYWNrU3RhdGUge1xuICB2YWxpZGF0aW9uOiBGaWVsZEZlZWRiYWNrVmFsaWRhdGlvbjtcblxuICAvLyBDb3B5IG9mIGlucHV0LnZhbGlkYXRpb25NZXNzYWdlXG4gIC8vIFNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL1dlYi9BUEkvSFRNTElucHV0RWxlbWVudFxuICAvLyBTZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSL2h0bWw1MS9zZWMtZm9ybXMuaHRtbCN0aGUtY29uc3RyYWludC12YWxpZGF0aW9uLWFwaVxuICB2YWxpZGF0aW9uTWVzc2FnZTogc3RyaW5nO1xufVxuXG4vLyBXaHkgTnVsbGFibGU/IFNlZSBodHRwczovL2dpdGh1Yi5jb20vRGVmaW5pdGVseVR5cGVkL0RlZmluaXRlbHlUeXBlZC9wdWxsLzI3OTczXG5leHBvcnQgdHlwZSBGaWVsZEZlZWRiYWNrQ29udGV4dCA9IEZvcm1XaXRoQ29uc3RyYWludHNDaGlsZENvbnRleHQgJiBGaWVsZEZlZWRiYWNrc0NoaWxkQ29udGV4dCAmIFBhcnRpYWw8TnVsbGFibGU8QXN5bmNDaGlsZENvbnRleHQ+PjtcblxuZXhwb3J0IGNsYXNzIEZpZWxkRmVlZGJhY2s8UHJvcHMgZXh0ZW5kcyBGaWVsZEZlZWRiYWNrQmFzZVByb3BzID0gRmllbGRGZWVkYmFja1Byb3BzPiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxQcm9wcywgRmllbGRGZWVkYmFja1N0YXRlPiB7XG4gIHN0YXRpYyBkZWZhdWx0UHJvcHM6IEZpZWxkRmVlZGJhY2tQcm9wcyA9IHtcbiAgICB3aGVuOiAoKSA9PiB0cnVlLFxuICAgIGNsYXNzZXM6IHtcbiAgICAgIGVycm9yOiAnZXJyb3InLFxuICAgICAgd2FybmluZzogJ3dhcm5pbmcnLFxuICAgICAgaW5mbzogJ2luZm8nLFxuICAgICAgd2hlblZhbGlkOiAnd2hlbi12YWxpZCdcbiAgICB9XG4gIH07XG5cbiAgc3RhdGljIGNvbnRleHRUeXBlczogUmVhY3QuVmFsaWRhdGlvbk1hcDxGaWVsZEZlZWRiYWNrQ29udGV4dD4gPSB7XG4gICAgZm9ybTogUHJvcFR5cGVzLmluc3RhbmNlT2YoRm9ybVdpdGhDb25zdHJhaW50cykuaXNSZXF1aXJlZCxcbiAgICBmaWVsZEZlZWRiYWNrczogUHJvcFR5cGVzLmluc3RhbmNlT2YoRmllbGRGZWVkYmFja3MpLmlzUmVxdWlyZWQsXG4gICAgYXN5bmM6IFByb3BUeXBlcy5pbnN0YW5jZU9mKEFzeW5jKVxuICB9O1xuICBjb250ZXh0ITogRmllbGRGZWVkYmFja0NvbnRleHQ7XG5cbiAgLy8gVGVzdGVkOiB0aGVyZSBpcyBubyBjb25mbGljdCB3aXRoIFJlYWN0IGtleSBwcm9wIChodHRwczovL3JlYWN0anMub3JnL2RvY3MvbGlzdHMtYW5kLWtleXMuaHRtbClcbiAgcmVhZG9ubHkga2V5OiBzdHJpbmc7IC8vICcwLjEnLCAnMS4wJywgJzMuNScuLi5cblxuICBjb25zdHJ1Y3Rvcihwcm9wczogUHJvcHMsIGNvbnRleHQ6IEZpZWxkRmVlZGJhY2tDb250ZXh0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgdGhpcy5rZXkgPSBjb250ZXh0LmZpZWxkRmVlZGJhY2tzLmFkZEZpZWxkRmVlZGJhY2soKTtcblxuICAgIGNvbnN0IHsgZXJyb3IsIHdhcm5pbmcsIGluZm8sIHdoZW4gfSA9IHByb3BzO1xuXG4gICAgbGV0IHR5cGUgPSBGaWVsZEZlZWRiYWNrVHlwZS5FcnJvcjsgLy8gRGVmYXVsdCBpcyBlcnJvclxuICAgIGlmICh3aGVuID09PSAndmFsaWQnKSB0eXBlID0gRmllbGRGZWVkYmFja1R5cGUuV2hlblZhbGlkO1xuICAgIGVsc2UgaWYgKHdhcm5pbmcpIHR5cGUgPSBGaWVsZEZlZWRiYWNrVHlwZS5XYXJuaW5nO1xuICAgIGVsc2UgaWYgKGluZm8pIHR5cGUgPSBGaWVsZEZlZWRiYWNrVHlwZS5JbmZvO1xuXG4gICAgLy8gU3BlY2lhbCBjYXNlIGZvciB3aGVuPVwidmFsaWRcIlxuICAgIGlmICh0eXBlID09PSBGaWVsZEZlZWRiYWNrVHlwZS5XaGVuVmFsaWQgJiYgKGVycm9yIHx8IHdhcm5pbmcgfHwgaW5mbykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhdmUgYW4gYXR0cmlidXRlIChlcnJvciwgd2FybmluZy4uLikgd2l0aCBGaWVsZEZlZWRiYWNrIHdoZW49XCJ2YWxpZFwiJyk7XG4gICAgfVxuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIHZhbGlkYXRpb246IHtcbiAgICAgICAga2V5OiB0aGlzLmtleSxcbiAgICAgICAgdHlwZSxcbiAgICAgICAgc2hvdzogdW5kZWZpbmVkIC8vIHVuZGVmaW5lZCBtZWFucyB0aGUgRmllbGRGZWVkYmFjayB3YXMgbm90IGNoZWNrZWRcbiAgICAgIH0sXG4gICAgICB2YWxpZGF0aW9uTWVzc2FnZTogJydcbiAgICB9O1xuICB9XG5cbiAgY29tcG9uZW50V2lsbE1vdW50KCkge1xuICAgIGNvbnN0IHsgZm9ybSwgZmllbGRGZWVkYmFja3MsIGFzeW5jIH0gPSB0aGlzLmNvbnRleHQ7XG5cbiAgICBpZiAoYXN5bmMpIGFzeW5jLmFkZFZhbGlkYXRlRmllbGRFdmVudExpc3RlbmVyKHRoaXMudmFsaWRhdGUpO1xuICAgIGVsc2UgZmllbGRGZWVkYmFja3MuYWRkVmFsaWRhdGVGaWVsZEV2ZW50TGlzdGVuZXIodGhpcy52YWxpZGF0ZSk7XG5cbiAgICBmb3JtLmFkZEZpZWxkRGlkUmVzZXRFdmVudExpc3RlbmVyKHRoaXMuZmllbGREaWRSZXNldCk7XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICBjb25zdCB7IGZvcm0sIGZpZWxkRmVlZGJhY2tzLCBhc3luYyB9ID0gdGhpcy5jb250ZXh0O1xuXG4gICAgaWYgKGFzeW5jKSBhc3luYy5yZW1vdmVWYWxpZGF0ZUZpZWxkRXZlbnRMaXN0ZW5lcih0aGlzLnZhbGlkYXRlKTtcbiAgICBlbHNlIGZpZWxkRmVlZGJhY2tzLnJlbW92ZVZhbGlkYXRlRmllbGRFdmVudExpc3RlbmVyKHRoaXMudmFsaWRhdGUpO1xuXG4gICAgZm9ybS5yZW1vdmVGaWVsZERpZFJlc2V0RXZlbnRMaXN0ZW5lcih0aGlzLmZpZWxkRGlkUmVzZXQpO1xuICB9XG5cbiAgdmFsaWRhdGUgPSAoaW5wdXQ6IElucHV0RWxlbWVudCkgPT4ge1xuICAgIGNvbnN0IHsgd2hlbiB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGZvcm0sIGZpZWxkRmVlZGJhY2tzIH0gPSB0aGlzLmNvbnRleHQ7XG5cbiAgICBjb25zdCBmaWVsZCA9IGZvcm0uZmllbGRzU3RvcmUuZ2V0RmllbGQoaW5wdXQubmFtZSkhO1xuXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHsuLi50aGlzLnN0YXRlLnZhbGlkYXRpb259OyAvLyBDb3B5IHN0YXRlIHNvIHdlIGRvbid0IG1vZGlmeSBpdCBkaXJlY3RseSAodXNlIG9mIHNldFN0YXRlKCkgaW5zdGVhZClcblxuICAgIGlmIChmaWVsZEZlZWRiYWNrcy5wcm9wcy5zdG9wID09PSAnZmlyc3QnICYmIGZpZWxkLmhhc0ZlZWRiYWNrcyhmaWVsZEZlZWRiYWNrcy5rZXkpIHx8XG4gICAgICAgIGZpZWxkRmVlZGJhY2tzLnByb3BzLnN0b3AgPT09ICdmaXJzdC1lcnJvcicgJiYgZmllbGQuaGFzRXJyb3JzKGZpZWxkRmVlZGJhY2tzLmtleSkgfHxcbiAgICAgICAgZmllbGRGZWVkYmFja3MucHJvcHMuc3RvcCA9PT0gJ2ZpcnN0LXdhcm5pbmcnICYmIGZpZWxkLmhhc1dhcm5pbmdzKGZpZWxkRmVlZGJhY2tzLmtleSkgfHxcbiAgICAgICAgZmllbGRGZWVkYmFja3MucHJvcHMuc3RvcCA9PT0gJ2ZpcnN0LWluZm8nICYmIGZpZWxkLmhhc0luZm9zKGZpZWxkRmVlZGJhY2tzLmtleSkpIHtcbiAgICAgIC8vIERvIG5vdGhpbmdcbiAgICAgIHZhbGlkYXRpb24uc2hvdyA9IHVuZGVmaW5lZDsgLy8gdW5kZWZpbmVkIG1lYW5zIHRoZSBGaWVsZEZlZWRiYWNrIHdhcyBub3QgY2hlY2tlZFxuICAgIH1cblxuICAgIGVsc2Uge1xuICAgICAgdmFsaWRhdGlvbi5zaG93ID0gZmFsc2U7XG5cbiAgICAgIGlmICh0eXBlb2Ygd2hlbiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICB2YWxpZGF0aW9uLnNob3cgPSB3aGVuKGlucHV0LnZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgZWxzZSBpZiAodHlwZW9mIHdoZW4gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGlmICh3aGVuID09PSAndmFsaWQnKSB7XG4gICAgICAgICAgLy8gdW5kZWZpbmVkID0+IHNwZWNpYWwgY2FzZSBmb3Igd2hlbj1cInZhbGlkXCI6IGFsd2F5cyBkaXNwbGF5ZWQsIHRoZW4gRmllbGRGZWVkYmFja1doZW5WYWxpZCBkZWNpZGVzIHdoYXQgdG8gZG9cbiAgICAgICAgICB2YWxpZGF0aW9uLnNob3cgPSB1bmRlZmluZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgdmFsaWRpdHkgPSBpbnB1dC52YWxpZGl0eTtcblxuICAgICAgICAgIGlmICghdmFsaWRpdHkudmFsaWQpIHtcbiAgICAgICAgICAgIGlmICh3aGVuID09PSAnKicpIHtcbiAgICAgICAgICAgICAgdmFsaWRhdGlvbi5zaG93ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKFxuICAgICAgICAgICAgICB2YWxpZGl0eS5iYWRJbnB1dCAmJiB3aGVuID09PSAnYmFkSW5wdXQnIHx8XG4gICAgICAgICAgICAgIHZhbGlkaXR5LnBhdHRlcm5NaXNtYXRjaCAmJiB3aGVuID09PSAncGF0dGVybk1pc21hdGNoJyB8fFxuICAgICAgICAgICAgICB2YWxpZGl0eS5yYW5nZU92ZXJmbG93ICYmIHdoZW4gPT09ICdyYW5nZU92ZXJmbG93JyB8fFxuICAgICAgICAgICAgICB2YWxpZGl0eS5yYW5nZVVuZGVyZmxvdyAmJiB3aGVuID09PSAncmFuZ2VVbmRlcmZsb3cnIHx8XG4gICAgICAgICAgICAgIHZhbGlkaXR5LnN0ZXBNaXNtYXRjaCAmJiB3aGVuID09PSAnc3RlcE1pc21hdGNoJyB8fFxuICAgICAgICAgICAgICB2YWxpZGl0eS50b29Mb25nICYmIHdoZW4gPT09ICd0b29Mb25nJyB8fFxuICAgICAgICAgICAgICB2YWxpZGl0eS50b29TaG9ydCAmJiB3aGVuID09PSAndG9vU2hvcnQnIHx8XG4gICAgICAgICAgICAgIHZhbGlkaXR5LnR5cGVNaXNtYXRjaCAmJiB3aGVuID09PSAndHlwZU1pc21hdGNoJyB8fFxuICAgICAgICAgICAgICB2YWxpZGl0eS52YWx1ZU1pc3NpbmcgJiYgd2hlbiA9PT0gJ3ZhbHVlTWlzc2luZycpIHtcblxuICAgICAgICAgICAgICB2YWxpZGF0aW9uLnNob3cgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgSW52YWxpZCBGaWVsZEZlZWRiYWNrICd3aGVuJyB0eXBlOiAke3R5cGVvZiB3aGVufWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZpZWxkLmFkZE9yUmVwbGFjZVZhbGlkYXRpb24odmFsaWRhdGlvbik7XG5cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIHZhbGlkYXRpb24sXG4gICAgICB2YWxpZGF0aW9uTWVzc2FnZTogaW5wdXQudmFsaWRhdGlvbk1lc3NhZ2VcbiAgICB9KTtcblxuICAgIHJldHVybiB2YWxpZGF0aW9uO1xuICB9XG5cbiAgZmllbGREaWRSZXNldCA9IChmaWVsZDogRmllbGQpID0+IHtcbiAgICBpZiAoZmllbGQubmFtZSA9PT0gdGhpcy5jb250ZXh0LmZpZWxkRmVlZGJhY2tzLmZpZWxkTmFtZSkgeyAvLyBJZ25vcmUgdGhlIGV2ZW50IGlmIGl0J3Mgbm90IGZvciB1c1xuICAgICAgdGhpcy5zZXRTdGF0ZShwcmV2U3RhdGUgPT4gKHtcbiAgICAgICAgdmFsaWRhdGlvbjogey4uLnByZXZTdGF0ZS52YWxpZGF0aW9uLCAuLi57c2hvdzogdW5kZWZpbmVkfX0sXG4gICAgICAgIHZhbGlkYXRpb25NZXNzYWdlOiAnJ1xuICAgICAgfSkpO1xuICAgIH1cbiAgfVxuXG4gIC8vIERvbid0IGZvcmdldCB0byB1cGRhdGUgbmF0aXZlL0ZpZWxkRmVlZGJhY2sucmVuZGVyKClcbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgd2hlbiwgZXJyb3IsIHdhcm5pbmcsIGluZm8sIGNsYXNzTmFtZSwgY2xhc3Nlcywgc3R5bGUsIGNoaWxkcmVuLCAuLi5vdGhlclByb3BzIH0gPSB0aGlzLnByb3BzIGFzIHVua25vd24gYXMgRmllbGRGZWVkYmFja1Byb3BzO1xuICAgIGNvbnN0IHsgdmFsaWRhdGlvbiwgdmFsaWRhdGlvbk1lc3NhZ2UgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICBjb25zdCBmaWVsZEZlZWRiYWNrQ2xhc3NOYW1lID0gY2xhc3NlcyFbdmFsaWRhdGlvbi50eXBlXSE7XG4gICAgY29uc3QgY2xhc3NOYW1lcyA9IGNsYXNzTmFtZSAhPT0gdW5kZWZpbmVkID8gYCR7Y2xhc3NOYW1lfSAke2ZpZWxkRmVlZGJhY2tDbGFzc05hbWV9YCA6IGZpZWxkRmVlZGJhY2tDbGFzc05hbWU7XG5cbiAgICAvLyBTcGVjaWFsIGNhc2UgZm9yIHdoZW49XCJ2YWxpZFwiOiBhbHdheXMgZGlzcGxheWVkLCB0aGVuIEZpZWxkRmVlZGJhY2tXaGVuVmFsaWQgZGVjaWRlcyB3aGF0IHRvIGRvXG4gICAgaWYgKHZhbGlkYXRpb24udHlwZSA9PT0gRmllbGRGZWVkYmFja1R5cGUuV2hlblZhbGlkKSB7XG4gICAgICByZXR1cm4gPEZpZWxkRmVlZGJhY2tXaGVuVmFsaWQgZGF0YS1mZWVkYmFjaz17dGhpcy5rZXl9IHN0eWxlPXtzdHlsZX0gY2xhc3NOYW1lPXtjbGFzc05hbWVzfSB7Li4ub3RoZXJQcm9wc30+e2NoaWxkcmVufTwvRmllbGRGZWVkYmFja1doZW5WYWxpZD47XG4gICAgfVxuXG4gICAgaWYgKHZhbGlkYXRpb24uc2hvdykge1xuICAgICAgY29uc3QgZmVlZGJhY2sgPSBjaGlsZHJlbiAhPT0gdW5kZWZpbmVkID8gY2hpbGRyZW4gOiB2YWxpZGF0aW9uTWVzc2FnZTtcblxuICAgICAgLy8gPHNwYW4gc3R5bGU9XCJkaXNwbGF5OiBibG9ja1wiPiBpbnN0ZWFkIG9mIDxkaXY+IHNvIEZpZWxkRmVlZGJhY2sgY2FuIGJlIHdyYXBwZWQgaW5zaWRlIGEgPHA+XG4gICAgICByZXR1cm4gPHNwYW4gZGF0YS1mZWVkYmFjaz17dGhpcy5rZXl9IGNsYXNzTmFtZT17Y2xhc3NOYW1lc30gc3R5bGU9e3tkaXNwbGF5OiAnYmxvY2snLCAuLi5zdHlsZX19IHsuLi5vdGhlclByb3BzfT57ZmVlZGJhY2t9PC9zcGFuPjtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuIl19